#!/usr/bin/env ruby

require 'pry'
require 'bundler/setup'
require 'dotenv'
require 'logger'
require 'httplog'
require 'byebug'

# Monkey patch Net::HTTP GET to log its details.
HttpLog.configure do |config|
  config.log_connect    = false
  config.log_request    = true
  config.log_headers    = false
  config.log_data       = false
  config.log_status     = true
  config.log_response   = false
  config.log_benchmark  = true

  config.compact_log    = true
  config.json_log       = true
end

# Require the code and set the DB connection details from the ENV.
load 'lib/wgit/database/connection_details.rb'
Dotenv.load
Wgit.set_connection_details_from_env

# Define a method to facilitate the reloading of code changes.
# NOTE: The CWD is the project root, not the bin folder.
def reload
  original_verbose = $VERBOSE
  $VERBOSE = nil              # Suppress warning messages (when reloading CONSTANTS).
  load 'load.rb'              # Reload all code changes.
  $VERBOSE = original_verbose # Activate warning messages again globally.

  # Set the Wgit logger level to Logger::DEBUG.
  Wgit.logger.level = Logger::DEBUG

  true
end

# Load the most recent code into the session, include modules, connect to DB etc.
reload

# Seed some fixture data for the session.
crawler = Crawler.new
url = Url.new "https://motherfuckingwebsite.com/"
doc = Document.new "http://www.mytestsite.com".to_url, File.read("test/mock/fixtures/test_doc.html")
db = Database.new

# Print some basic usage information.
def info
  puts "To load your code changes type: reload\n"
  puts "See the DatabaseHelper module for DB interaction methods which include:"
  puts "nuke, seed, index, search, num_urls, num_docs, num_records\n"
  puts "Available fixture vars include: crawler, url, doc, db"
  puts "To see this help information again type: info"
  puts "When you're finished type: exit"
end

# Start the pry session.
puts "\nStarting an interactive session to play, do great things...\n\n"
info
binding.pry
puts "Interactive session complete, hope you had a good one!"

# Do any post REPL cleanup tasks here...
